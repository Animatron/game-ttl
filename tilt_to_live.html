<!DOCTYPE html>
<html>
	<head>
		<title>Tilt to Live - Animatron HTML5 Player Demo</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script src="../player/vendor/matrix.js" type="text/javascript"></script>
		<script src="../player/anm.player.js" type="text/javascript"></script>
		<script src="../player/anm.builder.js" type="text/javascript"></script>
        <script src="../player/anm.collisions.js" type="text/javascript"></script>
		<script src="../player/animatron_import.js" type="text/javascript"></script>

		<script type="text/javascript">	
            function start() {
                var b = Builder._$, B = Builder, C = anm.C;
				var width = 640;
				var height = 480;
				
				var points = 0;
				var time = 0;
				
				var numEnemies = 50;
				var spawn = [4, 16];
				
				var mouseX = 0;
				var mouseY = 0;
				var targetX = 0;
				var targetY = 0;
				
          		var dot = b().circle([ 0, 0 ], 4).fill('#f00');
				var swarm = new Array(numEnemies);
				var msg = b().paint(function(ctx) {
      							ctx.font = '30pt sans-serif';
      							ctx.fillText('Game Over', 210, 260);
    						});
				var scoreDisp = b().paint(function(ctx) {
      							ctx.font = '18pt sans-serif';
      							ctx.fillText(''+Math.floor(time+points), 8, height-8);
    						});
							var over = false;
				
				var lastTime = new Array(numEnemies);
				var spawnTime = new Array(numEnemies);
				
				var maxPowerups = 2;
				var powerRate = .01;
				var powerSet = [b().circle([ 0, 0 ], 6).fill('#ff0'), b().circle([ 0, 0 ], 6).fill('#0f0')];
				var powerups = new Array();
				var powerType = new Array();
				// nullify all powerup slots
				for (var i=0; i<maxPowerups; i++)
					powerups.push(null);
					
				// powerup variables
				var shield = false;
				var explode = false;
				
				// canvas 1
				var scene1 = b();
				
				var baseModifier = function(t) {
					if (Math.random() <= powerRate) {
						var type = Math.floor(Math.random()*powerSet.length);
						for (var i=0; i<maxPowerups; i++) {
							if (powerups[i] == null) {
								var p = b(powerSet[type]).modify(powerModifier, i);
								powerups[i] = p;
								powerType[i] = type;
								scene1.add(p);
								console.log("created powerup type "+type);
								break;
							}
						}
					}
					// update time
					if (!over)
						time = t;
				}
				
				var explodeModifer = function(t) {
					if (this.sx > 6)
						scene1.remove(this);
					else {
						this.sx *= 1.1;
						this.sy *= 1.1;
					}
				}
				
				var powerModifier = function(t, i) {
					// set position
					if (this.x == 0 && this.y == 0) {
						this.x = Math.random()*width;
						this.y = Math.random()*height;
					}
					// collision check
					if (this.$.intersects(dot.v)) {
					//if ((this.x - targetX)*(this.x - targetX) + (this.y - targetY)*(this.y - targetY) <= 81) {
						console.log("triggered powerup type "+powerType[i]);
						scene1.remove(powerups[i]);
						powerups[i] = null;
						// handle each powerup
						switch (powerType[i]) {
							case 0: explode = true; break;
							//case 0: b().circle([ 0, 0 ], 6).fill('#ff0').stroke('#000', 0)
							//		.modify(explodeModifier);
							case 1: shield = true;
						}
						if (!over)
							points += 30;
					}
				}
				
				var enemyModifier = function(t, i) {
					// the check for t doesn't make sense
					if (t > 1) {
						if (t >= spawnTime[i]) {
							// initialize position
							this.x = Math.random()*width;
							this.y = Math.random()*height;
							
							// randomize next spawn
							lastTime[i] = spawnTime[i];
							spawnTime[i] = t + Math.random()*(spawn[1] - spawn[0]) + spawn[0];
						}
						this.x += (targetX - this.x > 0 ? 1 : -1) * Math.max(.1, Math.min(Math.atan(t - lastTime[i]), Math.abs(targetX - this.x)/20));
						this.y += (targetY - this.y > 0 ? 1 : -1) * Math.max(.1, Math.min(Math.atan(t - lastTime[i]), Math.abs(targetY - this.y)/20));
						
						// collision check
						if (explode) {
							if ((this.x - targetX)*(this.x - targetX) + (this.y - targetY)*(this.y - targetY) <= 6400 && !over)
								points += 5;
							while ((this.x - targetX)*(this.x - targetX) + (this.y - targetY)*(this.y - targetY) <= 6400) {
								this.x = Math.random()*width;
								this.y = Math.random()*height;
							}
						} else if (this.$.intersects(dot.v)) {
						//} else if ((this.x - targetX)*(this.x - targetX) + (this.y - targetY)*(this.y - targetY) <= 16) {
								if (shield) {
									shield = false;
									spawnTime[i] = 0;
								} else {
									over = true;
									msg.enable();
								}
						}
						if (i == numEnemies-1 && explode)
							explode = false;
					}
				};
				
				var playerModifier = function(t) {
					// update position
					this.x += (mouseX - this.x)/10;
					this.y += (mouseY - this.y)/10;
					targetX = this.x;
					targetY = this.y;
					
					if (shield)
						dot.stroke('#0f0', 2);
					else
						dot.stroke('#000', 1);
				}
				
				var area = b().rect([width/2, height/2], [width, height]).fill('#fff').modify(baseModifier);
				dot.on(C.X_MMOVE, function(evt) {
					mouseX = evt.pos[0];
					mouseY = evt.pos[1];
				}).modify(playerModifier);
				scene1.add(area);
				for (var i=0; i<swarm.length; i++) {
					spawnTime[i] = 0;
					swarm[i] = b().circle([ 0, 0 ], 2).fill('#000')
							.modify(enemyModifier, i);
					scene1.add(swarm[i]);
				}
				scene1.add(dot);
				scene1.add(msg);
				scene1.add(scoreDisp);
				msg.disable();
				
                createPlayer('canvas1', {'mode': C.M_DYNAMIC}).load(scene1).play();
    
            }
        </script>
      </head>

	<body onload="start();">
		<h1>Tilt to Live - Animatron HTML5 Player Demo</h1>

		<!-- canvas1 -->
		<canvas id="canvas1" width="640" height="480"></canvas>

	</body>

</html>